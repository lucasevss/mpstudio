<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enviar Arquivos Grande MPStudio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 640px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 24px;
            font-size: 14px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #4a4a4a;
        }

        .text-input, .token-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .token-textarea {
            min-height: 70px;
            resize: vertical;
        }

        .text-input:focus,
        .token-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .drop-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .drop-zone:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .drop-zone.drag-over {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .drop-zone-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .drop-zone-text {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .drop-zone-hint {
            color: #999;
            font-size: 14px;
        }

        .file-input {
            display: none;
        }

        .file-info {
            margin-top: 20px;
            padding: 20px;
            background: #f0f2ff;
            border-radius: 10px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .file-size {
            color: #666;
            font-size: 14px;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.1s ease, box-shadow 0.3s ease, opacity 0.3s ease;
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.35);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.45);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }

        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
            font-size: 14px;
            line-height: 1.4;
        }

        .status-message.show {
            display: block;
        }

        .status-message.loading {
            background: #fff5d6;
            color: #8a6d1f;
            border-left: 4px solid #f2c94c;
        }

        .status-message.success {
            background: #e8f9f0;
            color: #207d4a;
            border-left: 4px solid #27ae60;
        }

        .status-message.error {
            background: #fdeaea;
            color: #c23616;
            border-left: 4px solid #eb5757;
        }

        .shared-link {
            margin-top: 10px;
            font-size: 14px;
            word-break: break-all;
            display: none;
        }

        .shared-link.show a {
            color: #2d4bff;
            text-decoration: none;
        }

        .shared-link.show a:hover {
            text-decoration: underline;
        }

        .phone-banner {
            margin-bottom: 16px;
            padding: 12px 18px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.4;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            box-shadow: 0 12px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .phone-banner.info {
            background: rgba(39, 174, 96, 0.85);
        }

        .phone-banner.warning {
            background: rgba(235, 87, 87, 0.85);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="phone-banner" id="phoneBanner"></div>
        <h1>MPStudio - Envio de arquivos grandes pro Whatsapp</h1>
        <p class="subtitle">
            Fa√ßa o upload do arquivo que deseja enviar e confira se na URL est√° o n√∫mero correto do cliente.
            Se desejar, renomeie o arquivo abaixo. Se ficar em branco, ele ir√° com o nome original para o cliente..
        </p>

        <div class="form-group">
            <label for="customFileName" class="form-label">Nome do arquivo (opcional)</label>
            <input type="text" id="customFileName" class="text-input" placeholder="Ex.: Projeto Executivo Joao e Maria vFinal">
        </div>

        <div class="drop-zone" id="dropZone">
            <div class="drop-zone-icon">üìÑ</div>
            <div class="drop-zone-text">Arraste seu PDF aqui</div>
            <div class="drop-zone-hint">ou clique para selecionar</div>
        </div>

        <input type="file" id="fileInput" class="file-input" accept="application/pdf">

        <div class="file-info" id="fileInfo">
            <div class="file-name" id="fileName"></div>
            <div class="file-size" id="fileSize"></div>
        </div>

        <button class="submit-btn" id="submitBtn" disabled>Enviar</button>

        <div class="status-message" id="statusMessage"></div>
        <div class="shared-link" id="sharedLink"></div>
    </div>

    <script>
        const phoneBanner = document.getElementById('phoneBanner');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const submitBtn = document.getElementById('submitBtn');
        const statusMessage = document.getElementById('statusMessage');
        const sharedLink = document.getElementById('sharedLink');
        const customFileNameInput = document.getElementById('customFileName');
        const LITTERBOX_API_URL = 'https://litterbox.catbox.moe/resources/internals/api.php';
        const LITTERBOX_DEFAULT_EXPIRY = '1h';
        const WEBHOOK_URL = 'https://webhook.melinapinheiro.com.br/webhook/send_file';
        const PHONE_PARAM = new URLSearchParams(window.location.search).get('phone');
        const PHONE_RAW = PHONE_PARAM ? PHONE_PARAM.split('@')[0] : '';
        const PHONE_DIGITS = PHONE_RAW ? PHONE_RAW.replace(/\D+/g, '') : '';
        const PHONE_DISPLAY = PHONE_DIGITS || null;

        let selectedFile = null;
        let lastUploadedName = '';

        updatePhoneBanner();

        function updatePhoneBanner() {
            if (!phoneBanner) {
                return;
            }

            if (PHONE_DISPLAY) {
                phoneBanner.textContent = `O arquivo sera enviado para o numero ${PHONE_DISPLAY}.`;
                phoneBanner.classList.remove('warning');
                phoneBanner.classList.add('info');
            } else {
                phoneBanner.textContent = 'Nenhum telefone selecionado. Atualize o endereco da pagina incluindo ?phone=NUMERO.';
                phoneBanner.classList.remove('info');
                phoneBanner.classList.add('warning');
            }
        }

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.add('drag-over');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('drag-over');
            });
        });

        dropZone.addEventListener('drop', e => {
            const files = e.dataTransfer.files;
            handleFile(files[0]);
        });

        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', e => {
            handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (!file) return;

            if (file.type !== 'application/pdf') {
                showStatus('Envie apenas arquivos PDF.', 'error');
                return;
            }

            selectedFile = file;
            fileName.textContent = `üìé ${file.name}`;
            fileSize.textContent = `Tamanho: ${formatFileSize(file.size)}`;
            fileInfo.classList.add('show');
            sharedLink.classList.remove('show');
            sharedLink.textContent = '';
            checkFormValid();
        }

        function checkFormValid() {
            submitBtn.disabled = !selectedFile;
        }

        submitBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            const names = buildFileNames(customFileNameInput.value.trim(), selectedFile.name);
            const fileForUpload = prepareFileForUpload(selectedFile, names.uploadName);
            lastUploadedName = names.displayName;

            submitBtn.disabled = true;
            showStatus('Preparando arquivo... 0%', 'loading');
            sharedLink.classList.remove('show');
            sharedLink.textContent = '';

            try {
                const link = await uploadFileToLitterbox(fileForUpload, LITTERBOX_DEFAULT_EXPIRY, progress => {
                    const percent = Math.min(100, Math.round(progress * 100));
                    showStatus(`Enviando para Litterbox... ${percent}%`, 'loading');
                });

                sharedLink.innerHTML = `Link compartilhado: <a href="${link}" target="_blank" rel="noopener noreferrer">${link}</a>`;
                sharedLink.classList.add('show');

                showStatus(buildSendingMessage(), 'loading');
                await notifyWebhook(link, names.displayName, PHONE_PARAM);

                showStatus(buildSuccessMessage(), 'success');
                setTimeout(() => {
                    resetForm();
                }, 4000);
            } catch (error) {
                console.error('Erro durante o envio:', error);
                showStatus(translateError(error), 'error');
            } finally {
                submitBtn.disabled = false;
            }
        });

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function buildFileNames(customName, originalName) {
            const extension = getFileExtension(originalName);
            const originalBase = removeExtension(originalName);
            const displayBase = customName || originalBase;
            const displayName = extension ? `${displayBase}.${extension}` : displayBase;

            const sanitizedBase = sanitizeFileName(displayBase);
            const safeBase = sanitizedBase || `arquivo_${Date.now()}`;
            const sanitizedExtension = sanitizeExtension(extension);
            const uploadName = sanitizedExtension ? `${safeBase}.${sanitizedExtension}` : safeBase;

            return {
                displayName,
                uploadName
            };
        }

        function getFileExtension(fileName) {
            const lastDot = fileName.lastIndexOf('.');
            if (lastDot === -1 || lastDot === fileName.length - 1) return '';
            return fileName.slice(lastDot + 1);
        }

        function removeExtension(fileName) {
            const lastDot = fileName.lastIndexOf('.');
            if (lastDot <= 0) return fileName;
            return fileName.slice(0, lastDot);
        }

        function sanitizeFileName(value) {
            if (!value) return '';
            let result = value;
            if (typeof result.normalize === 'function') {
                result = result.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            }
            return result
                .replace(/[^A-Za-z0-9._-]+/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_+|_+$/g, '');
        }

        function sanitizeExtension(extension) {
            if (!extension) return '';
            let result = extension;
            if (typeof result.normalize === 'function') {
                result = result.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            }
            const clean = result.replace(/[^A-Za-z0-9]+/g, '').toLowerCase();
            return clean || '';
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message show ${type}`;
        }

        function prepareFileForUpload(file, desiredName) {
            if (!desiredName || desiredName === file.name) {
                return file;
            }

            if (typeof File !== 'function') {
                console.warn('File constructor indisponivel neste navegador; mantendo nome original.');
                return file;
            }

            try {
                return new File([file], desiredName, { type: file.type });
            } catch (err) {
                try {
                    const blob = file.slice(0, file.size, file.type);
                    return new File([blob], desiredName, { type: file.type });
                } catch (fallbackErr) {
                    console.warn('Nao foi possivel renomear o arquivo antes do upload, usando nome original.', fallbackErr);
                    return file;
                }
            }
        }

        async function uploadFileToLitterbox(file, expiry, onProgress) {
            const effectiveExpiry = expiry || LITTERBOX_DEFAULT_EXPIRY;
            const formData = new FormData();
            formData.append('reqtype', 'fileupload');
            formData.append('time', effectiveExpiry);
            formData.append('fileToUpload', file, file.name);

            if (typeof onProgress === 'function') {
                onProgress(0);
            }

            const response = await fetch(LITTERBOX_API_URL, {
                method: 'POST',
                body: formData
            });

            const payload = await response.text();

            if (!response.ok) {
                throw new Error(`Falha no upload: ${extractLitterboxError(payload)}`);
            }

            if (typeof onProgress === 'function') {
                onProgress(1);
            }

            const trimmed = (payload || '').trim();
            if (!/^https?:\/\//i.test(trimmed)) {
                throw new Error(`Resposta inesperada do Litterbox: ${trimmed || 'vazia'}`);
            }

            return trimmed;
        }

        function extractLitterboxError(rawText) {
            if (rawText == null) {
                return 'Erro desconhecido';
            }

            try {
                const parsed = JSON.parse(rawText);
                if (typeof parsed === 'string') {
                    return parsed;
                }
                if (parsed?.error) {
                    return typeof parsed.error === 'string' ? parsed.error : JSON.stringify(parsed.error);
                }
                if (parsed?.message) {
                    return parsed.message;
                }
            } catch (e) {
                // resposta j√° era texto simples
            }

            const trimmed = String(rawText).trim();
            return trimmed || 'Erro desconhecido';
        }

        async function notifyWebhook(link, filename, phone) {
            const payload = { url: link, filename };
            if (phone) {
                payload.phone = phone;
            }

            const response = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Falha ao notificar webhook: ${errorText || response.statusText}`);
            }
        }

        function translateError(error) {
            const rawMessage = error?.message || String(error) || 'Erro desconhecido';

            if (/Failed to fetch/i.test(rawMessage)) {
                return 'Nao foi possivel alcancar o Litterbox. Verifique conexao, firewall/VPN ou tente novamente em instantes.';
            }

            if (rawMessage.includes('Falha no upload')) {
                return rawMessage;
            }

            if (rawMessage.includes('Resposta inesperada do Litterbox')) {
                return rawMessage;
            }

            if (rawMessage.includes('Falha ao notificar webhook')) {
                return `Arquivo hospedado, mas nao conseguimos avisar o sistema. Detalhes: ${rawMessage}`;
            }

            return `Erro: ${rawMessage}`;
        }

        function desiredNameForMessage() {
            return lastUploadedName || (selectedFile ? selectedFile.name : 'seu arquivo');
        }

        function buildSendingMessage() {
            if (PHONE_DISPLAY) {
                return `Enviando link para o telefone ${PHONE_DISPLAY}...`;
            }
            return 'Enviando link...';
        }

        function buildSuccessMessage() {
            if (PHONE_DISPLAY) {
                return `Pronto! Arquivo ${desiredNameForMessage()} enviado para ${PHONE_DISPLAY}.`;
            }
            return `Upload concluido! Arquivo ${desiredNameForMessage()} enviado.`;
        }

        function resetForm() {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.classList.remove('show');
            submitBtn.disabled = true;
        }
    </script>
</body>
</html>
